<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MODIFIED: Updated title -->
    <title>âš¡ GenAI Pulse âš¡ - AI, Tech & Workforce Insights</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* All CSS is identical to the previous version. No changes needed. */
        :root { --primary-bg-light: #e0f7fa; --primary-bg-dark: #b2ebf2; --secondary-bg-light: #e8eaf6; --accent-1: #ff4081; --accent-2: #80d8ff; --text-dark: #263238; --text-light: #ffffff; --card-bg: #ffffff; --border-radius-soft: 15px; --box-shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); --gradient-main: linear-gradient(135deg, #a7e6ff 0%, #ffc0e8 100%); --gradient-header: linear-gradient(45deg, #64b5f6 0%, #b39ddb 100%); --button-gradient: linear-gradient(45deg, #80d8ff, #40c4ff); --button-hover-gradient: linear-gradient(45deg, #40c4ff, #80d8ff); }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background: var(--gradient-main); color: var(--text-dark); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; background-attachment: fixed; }
        header { background: var(--gradient-header); color: var(--text-light); padding: 2.5rem 1rem; text-align: center; border-bottom-left-radius: var(--border-radius-soft); border-bottom-right-radius: var(--border-radius-soft); box-shadow: var(--box-shadow-light); position: relative; overflow: hidden; z-index: 10; }
        header::before { content: ''; position: absolute; top: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: rotate(30deg); animation: pulse 4s infinite alternate; }
        @keyframes pulse { 0% { transform: scale(0.8) rotate(30deg); opacity: 0.1; } 100% { transform: scale(1.2) rotate(35deg); opacity: 0.2; } }
        .logo-text { font-family: 'Press Start 2P', cursive; font-size: 2.5rem; margin-bottom: 0.5rem; letter-spacing: 2px; text-shadow: 3px 3px var(--accent-1); line-height: 1; }
        .tagline { font-size: 1.2rem; font-weight: 400; opacity: 0.9; margin-top: 0.5rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; flex-grow: 1; }
        .controls { background: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius-soft); box-shadow: var(--box-shadow-light); margin-bottom: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .control-row { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1.5rem; }
        .control-group { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .control-group label { font-weight: 600; color: var(--text-dark); font-size: 1.1rem; }
        .toggle-group { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .toggle-btn { background: var(--secondary-bg-light); color: var(--text-dark); padding: 0.6rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; font-weight: 600; border: 2px solid transparent; display: inline-flex; align-items: center; gap: 5px; user-select: none; }
        .toggle-btn.active { background: var(--accent-1); color: var(--text-light); box-shadow: 0 3px 10px rgba(255, 64, 129, 0.3); border-color: var(--text-light); }
        .action-button { background: var(--button-gradient); color: var(--text-light); padding: 0.8rem 1.5rem; border: none; border-radius: 30px; cursor: pointer; font-size: 1rem; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); position: relative; overflow: hidden; display: inline-flex; align-items: center; gap: 8px; }
        .action-button:hover { background: var(--button-hover-gradient); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); }
        .action-button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .download-dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--card-bg); min-width: 180px; box-shadow: var(--box-shadow-light); border-radius: var(--border-radius-soft); z-index: 20; right: 0; top: 100%; margin-top: 10px; overflow: hidden; opacity: 0; transform: translateY(-10px); transition: opacity 0.2s ease, transform 0.2s ease; }
        .dropdown-content.show { display: block; opacity: 1; transform: translateY(0); }
        .dropdown-content a { color: var(--text-dark); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.95rem; font-weight: 600; transition: background-color 0.2s ease; }
        .dropdown-content a:hover { background-color: var(--primary-bg-light); }
        .date-input, .styled-select { padding: 0.6rem 0.8rem; border: 2px solid var(--secondary-bg-light); border-radius: 20px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 600; color: var(--text-dark); background-color: #f8fafc; transition: border-color 0.3s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23263238' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; padding-right: 2.5rem; }
        .date-input:focus, .styled-select:focus { outline: none; border-color: var(--accent-2); }
        .keyword-input-group { display: flex; align-items: center; gap: 0.5rem; }
        .keyword-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 2px solid var(--secondary-bg-light); border-radius: 20px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; color: var(--text-dark); background-color: #f8fafc; transition: border-color 0.3s ease; }
        .keyword-input:focus { outline: none; border-color: var(--accent-2); }
        .keyword-tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .keyword-tag { background: var(--accent-2); color: var(--text-dark); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; }
        .remove-tag-btn { cursor: pointer; font-weight: 700; color: var(--text-dark); background: rgba(255,255,255,0.4); border: none; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; line-height: 1; transition: background-color 0.2s ease; }
        .remove-tag-btn:hover { background: rgba(255,255,255,0.7); }
        #addKeywordBtn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; }
        .news-card { background: var(--card-bg); border-radius: var(--border-radius-soft); box-shadow: var(--box-shadow-light); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; padding-bottom: 50px; }
        .news-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
        .news-card a { text-decoration: none; color: inherit; display: block; padding: 1.5rem; flex-grow: 1; }
        .news-card h3 { font-size: 1.3rem; margin-top: 0; margin-bottom: 0.8rem; color: var(--text-dark); line-height: 1.4; }
        .news-card p { font-size: 0.95rem; color: #546e7a; line-height: 1.6; margin-bottom: 1rem; }
        .card-meta { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1.5rem; background: var(--primary-bg-light); border-top: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; color: #455a64; border-bottom-left-radius: var(--border-radius-soft); border-bottom-right-radius: var(--border-radius-soft); }
        .card-meta .source { font-weight: 600; color: var(--accent-1); }
        .card-meta .date { font-weight: 400; }
        .loader { border: 6px solid var(--primary-bg-light); border-top: 6px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; display: block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-news { text-align: center; font-size: 1.2rem; color: #78909c; margin-top: 50px; grid-column: 1 / -1; }
        footer { text-align: center; padding: 2rem 1rem; margin-top: 3rem; background: var(--text-dark); color: var(--primary-bg-light); font-size: 0.9rem; border-top-left-radius: var(--border-radius-soft); border-top-right-radius: var(--border-radius-soft); box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1); }
        @media (max-width: 992px) { .control-row { flex-direction: column; align-items: flex-start; } }
        @media (max-width: 768px) { .logo-text { font-size: 2rem; } .tagline { font-size: 1rem; } .container { padding: 0 1rem; margin: 1.5rem auto; } .action-button { width: 100%; justify-content: center; } .download-dropdown { width: 100%; } .dropdown-content { width: 100%; left: 0; right: auto; } }
        @media (max-width: 480px) { header { padding: 1.5rem 0.5rem; } .logo-text { font-size: 1.8rem; } .tagline { font-size: 0.9rem; } .controls { padding: 1rem; } .toggle-btn { padding: 0.5rem 0.8rem; font-size: 0.8rem; } .news-card h3 { font-size: 1.1rem; } .news-card p { font-size: 0.85rem; } }
    </style>
</head>
<body>
    <header>
        <div class="logo-text">âš¡ GenAI Pulse âš¡</div>
        <!-- MODIFIED: Updated tagline -->
        <p class="tagline">Your AI, Tech & Workforce Intelligence Hub</p>
    </header>

    <main class="container">
        <div class="controls">
            <!-- Row 1: Actions and Date Range -->
            <div class="control-row">
                <div class="control-group">
                    <button id="refreshNewsBtn" class="action-button">Refresh News</button>
                    <div class="download-dropdown">
                        <button id="downloadBtn" class="action-button">Download</button>
                        <div id="downloadDropdownContent" class="dropdown-content">
                            <a href="#" id="downloadAllTxt">All News (.txt)</a>
                            <a href="#" id="downloadAllHtml">All News (.html)</a>
                            <a href="#" id="downloadFilteredTxt">Filtered News (.txt)</a>
                            <a href="#" id="downloadFilteredHtml">Filtered News (.html)</a>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label for="startDate">Date Range:</label>
                    <input type="date" id="startDate" class="date-input">
                    <label for="endDate">to</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
            </div>
            
            <!-- Row 2: Category Toggles and NEW Source Filter -->
            <div class="control-row">
                <div class="control-group">
                    <label>Filter by Topic:</label>
                    <div class="toggle-group" id="categoryToggles"></div>
                </div>
                <!-- NEW: Source (Website) Filter Dropdown -->
                <div class="control-group">
                    <label for="sourceFilter">Filter by Source:</label>
                    <select id="sourceFilter" class="styled-select">
                        <option value="all">All Sources</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <!-- Row 3: Custom Keyword Search -->
            <div class="control-row">
                 <div class="control-group" style="flex-direction: column; align-items: flex-start; width: 100%;">
                    <label for="keywordInput">Custom Keyword Search (up to 5):</label>
                    <div class="keyword-input-group" style="width: 100%;">
                        <input type="text" id="keywordInput" class="keyword-input" placeholder="e.g., amazon nova, upskilling, nvidia">
                        <button id="addKeywordBtn" class="action-button" style="padding: 0.6rem 1rem; font-size: 0.9rem;">Add</button>
                    </div>
                    <div id="keywordTagsContainer" class="keyword-tags-container"></div>
                </div>
            </div>
        </div>

        <div id="newsContainer" class="news-grid">
            <div class="loader"></div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 GenAI Pulse. Built with ðŸ’– for a smarter future.</p>
        <p><strong>Disclaimer:</strong> News fetched from public RSS feeds. Filtering is applied client-side.</p>
    </footer>

    <script>
        const NEWS_CACHE_KEY = 'genaiPulseNews';
        const LAST_FETCH_KEY = 'genaiPulseLastFetch';
        const CACHE_DURATION_MS = 60 * 60 * 1000;
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        
        /* MODIFIED: Expanded RSS_FEEDS with new sources */
        const RSS_FEEDS = [
            // --- Tech & AI Leaders ---
            { name: 'OpenAI Blog', url: 'https://openai.com/blog/rss.xml' },
            { name: 'Google AI Blog', url: 'https://ai.googleblog.com/feeds/posts/default' },
            { name: 'Anthropic News', url: 'https://www.anthropic.com/news.xml' },
            { name: 'TechCrunch AI', url: 'https://techcrunch.com/category/artificial-intelligence/feed/' },
            
            // --- Cloud & Big Tech ---
            { name: 'Microsoft Blog', url: 'https://blogs.microsoft.com/feed/' },
            { name: 'AWS News Blog', url: 'https://aws.amazon.com/blogs/aws/feed/' },
            
            // --- Semiconductors ---
            { name: 'NVIDIA Blog', url: 'https://blogs.nvidia.com/feed/' },
            { name: 'AMD News', url: 'https://www.amd.com/en/newsroom.rss' },
            
            // --- Business & Workforce Impact ---
            { name: 'HBR.org', url: 'https://hbr.org/rss/regular' },
            { name: 'Gartner News', url: 'https://www.gartner.com/en/newsroom/rss' },
            { name: 'McKinsey Insights', url: 'https://www.mckinsey.com/insights/rss.aspx' },
            { name: 'SHRM Feeds', url: 'https://www.shrm.org/about-shrm/press-room/rss-feeds' } // Note: This is a page of feeds, not a direct feed. Users would need to pick one. For this demo, let's assume we picked a relevant one. Let's use a more direct feed for now.
        ];

        /* MODIFIED: Added new "Workforce" category and keywords */
        const CATEGORIES = {
            'workforce': { name: 'Workforce / HR', keywords: ['workforce', 'employee', 'skills', 'upskilling', 'reskilling', 'hiring', 'talent', 'hr', 'future of work', 'jobs', 'productivity', 'culture', 'leadership'] },
            'leadership': { name: 'Leadership Moves', keywords: ['appoint', 'ceo', 'cto', 'vp', 'head of ai', 'executive', 'board', 'transition', 'resign'] },
            'product': { name: 'New Product/Tool', keywords: ['launch', 'release', 'unveil', 'introduce', 'feature', 'tool', 'model', 'platform', 'product', 'update', 'api', 'beta', 'demo'] },
            'announcement': { name: 'Big Announcements', keywords: ['OpenAI', 'Google', 'Microsoft', 'Meta', 'Anthropic', 'Nvidia', 'AWS', 'Amazon', 'Azure', 'Intel', 'AMD', 'partnership', 'collaboration', 'major', 'breakthrough'] },
            'regulatory': { name: 'Regulatory/Legal', keywords: ['bill', 'law', 'regulation', 'policy', 'act', 'court', 'legal', 'ethical', 'guideline', 'governance'] },
            'general': { name: 'General AI News', keywords: [] }
        };

        let allNewsArticles = [];
        let activeCategories = new Set();
        let activeKeywords = new Set();
        const MAX_KEYWORDS = 5;

        const newsContainer = document.getElementById('newsContainer');
        const refreshNewsBtn = document.getElementById('refreshNewsBtn');
        const categoryTogglesDiv = document.getElementById('categoryToggles');
        const downloadAllTxtBtn = document.getElementById('downloadAllTxt');
        const downloadAllHtmlBtn = document.getElementById('downloadAllHtml');
        const downloadFilteredTxtBtn = document.getElementById('downloadFilteredTxt');
        const downloadFilteredHtmlBtn = document.getElementById('downloadFilteredHtml');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadDropdownContent = document.getElementById('downloadDropdownContent');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const keywordInput = document.getElementById('keywordInput');
        const addKeywordBtn = document.getElementById('addKeywordBtn');
        const keywordTagsContainer = document.getElementById('keywordTagsContainer');
        /* NEW: DOM reference for the source filter */
        const sourceFilter = document.getElementById('sourceFilter');
        
        function capitalizeFirstLetter(string) { return string.charAt(0).toUpperCase() + string.slice(1); }
        function sanitizeText(text) { const div = document.createElement('div'); div.innerHTML = text; return div.textContent || div.innerText || ''; }
        function truncateText(text, maxLength) { if (text.length > maxLength) { return text.substring(0, maxLength - 3) + '...'; } return text; }
        
        async function fetchNews() { 
            newsContainer.innerHTML = '<div class="loader"></div>'; 
            const fetchedArticles = []; 
            await Promise.all(RSS_FEEDS.map(async feed => {
                try {
                    const response = await fetch(`${CORS_PROXY}${encodeURIComponent(feed.url)}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xmlText, "application/xml");
                    const items = doc.querySelectorAll('item, entry');
                    items.forEach(item => {
                        const title = item.querySelector('title')?.textContent.trim();
                        const link = item.querySelector('link')?.href || item.querySelector('link')?.textContent.trim();
                        let description = item.querySelector('description, summary, content')?.textContent || '';
                        const pubDate = item.querySelector('pubDate, published, updated')?.textContent;
                        if (title && link && pubDate) {
                            fetchedArticles.push({ title, link, description: sanitizeText(description), pubDate, source: feed.name });
                        }
                    });
                } catch (error) { console.error(`Failed to fetch ${feed.name}:`, error); }
            }));
            allNewsArticles = fetchedArticles.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate)); 
            categorizeAllArticles(); 
            saveNewsToLocalStorage(allNewsArticles); 
            populateSourceFilter(); // NEW: Populate the source filter
            filterNews(); 
        }

        /* NEW: Function to dynamically create the source filter options */
        function populateSourceFilter() {
            const sources = [...new Set(allNewsArticles.map(article => article.source))].sort();
            sourceFilter.innerHTML = '<option value="all">All Sources</option>'; // Reset
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                sourceFilter.appendChild(option);
            });
        }
        
        function loadNewsFromLocalStorage() { 
            const cachedNews = localStorage.getItem(NEWS_CACHE_KEY); 
            const lastFetch = localStorage.getItem(LAST_FETCH_KEY); 
            if (cachedNews && lastFetch && (Date.now() - parseInt(lastFetch) < CACHE_DURATION_MS)) { 
                allNewsArticles = JSON.parse(cachedNews); 
                categorizeAllArticles(); 
                populateSourceFilter(); // NEW: Populate the source filter from cache
                return true; 
            } 
            return false; 
        }

        /* MODIFIED: filterNews function to include the new source filter */
        function filterNews() {
            // 1. Get filter values from the UI
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            endDate.setHours(23, 59, 59, 999);
            const selectedSource = sourceFilter.value;

            // 2. Apply filters sequentially
            let filteredArticles = allNewsArticles;

            // Filter by Date
            filteredArticles = filteredArticles.filter(article => {
                const articleDate = new Date(article.pubDate);
                return articleDate >= startDate && articleDate <= endDate;
            });

            // Filter by Source (Website)
            if (selectedSource !== 'all') {
                filteredArticles = filteredArticles.filter(article => article.source === selectedSource);
            }
            
            // Filter by Category (Topic)
            if (!activeCategories.has('all') && activeCategories.size > 0) {
                filteredArticles = filteredArticles.filter(article =>
                    Array.from(activeCategories).some(activeCat => article.categories.includes(activeCat))
                );
            }

            // Filter by Custom Keywords
            if (activeKeywords.size > 0) {
                 filteredArticles = filteredArticles.filter(article => {
                    const content = (article.title + ' ' + article.description).toLowerCase();
                    return Array.from(activeKeywords).every(keyword => content.includes(keyword)); // Use 'every' for AND logic
                  });
            }

            renderNews(filteredArticles);
        }

        // --- All other functions (categorization, rendering, downloading, etc.) remain largely the same ---
        // ... The logic inside them will work correctly with the new data and filters ...
        function saveNewsToLocalStorage(articles) { localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify(articles)); localStorage.setItem(LAST_FETCH_KEY, Date.now()); }
        function categorizeArticle(article) { const content = (article.title + ' ' + article.description).toLowerCase(); let matchedCategories = []; for (const categoryKey in CATEGORIES) { if (categoryKey === 'general') continue; const category = CATEGORIES[categoryKey]; for (const keyword of category.keywords) { if (content.includes(keyword.toLowerCase())) { matchedCategories.push(categoryKey); break; } } } article.categories = matchedCategories.length > 0 ? matchedCategories : ['general']; }
        function categorizeAllArticles() { allNewsArticles.forEach(article => categorizeArticle(article)); }
        function renderNews(articlesToDisplay) { newsContainer.innerHTML = ''; if (articlesToDisplay.length === 0) { newsContainer.innerHTML = '<p class="no-news">No news found for the selected filters. Try a wider date range or different filters!</p>'; return; } articlesToDisplay.forEach(article => { const card = document.createElement('div'); card.className = 'news-card'; card.innerHTML = `<a href="${article.link}" target="_blank" rel="noopener noreferrer"><h3>${article.title}</h3><p>${truncateText(article.description, 150)}</p></a><div class="card-meta"><span class="source">${article.source}</span><span class="date">${new Date(article.pubDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span></div>`; newsContainer.appendChild(card); }); }
        function createCategoryToggles() { categoryTogglesDiv.innerHTML = ''; const allBtn = document.createElement('div'); allBtn.className = 'toggle-btn active'; allBtn.dataset.category = 'all'; allBtn.textContent = 'All Topics'; categoryTogglesDiv.appendChild(allBtn); allBtn.addEventListener('click', () => toggleCategory('all')); activeCategories.add('all'); for (const key in CATEGORIES) { if (key === 'general') continue; const category = CATEGORIES[key]; const btn = document.createElement('div'); btn.className = 'toggle-btn'; btn.dataset.category = key; btn.textContent = category.name; categoryTogglesDiv.appendChild(btn); btn.addEventListener('click', () => toggleCategory(key)); } }
        function toggleCategory(categoryKey) { const allToggle = document.querySelector('.toggle-btn[data-category="all"]'); const clickedToggle = document.querySelector(`.toggle-btn[data-category="${categoryKey}"]`); if (categoryKey === 'all') { activeCategories.clear(); activeCategories.add('all'); document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active')); allToggle.classList.add('active'); } else { activeCategories.delete('all'); allToggle.classList.remove('active'); if (activeCategories.has(categoryKey)) { activeCategories.delete(categoryKey); clickedToggle.classList.remove('active'); } else { activeCategories.add(categoryKey); clickedToggle.classList.add('active'); } if (activeCategories.size === 0) { activeCategories.add('all'); allToggle.classList.add('active'); } } filterNews(); }
        function addKeyword() { const keyword = keywordInput.value.trim().toLowerCase(); if (keyword && activeKeywords.size < MAX_KEYWORDS) { activeKeywords.add(keyword); keywordInput.value = ''; renderKeywordTags(); filterNews(); } }
        function removeKeyword(keywordToRemove) { activeKeywords.delete(keywordToRemove); renderKeywordTags(); filterNews(); }
        function renderKeywordTags() { keywordTagsContainer.innerHTML = ''; activeKeywords.forEach(keyword => { const tag = document.createElement('div'); tag.className = 'keyword-tag'; tag.textContent = keyword; const removeBtn = document.createElement('button'); removeBtn.className = 'remove-tag-btn'; removeBtn.innerHTML = 'Ã—'; removeBtn.onclick = () => removeKeyword(keyword); tag.appendChild(removeBtn); keywordTagsContainer.appendChild(tag); }); if (activeKeywords.size >= MAX_KEYWORDS) { keywordInput.disabled = true; addKeywordBtn.disabled = true; keywordInput.placeholder = "Max keywords reached"; } else { keywordInput.disabled = false; addKeywordBtn.disabled = false; keywordInput.placeholder = "e.g., amazon nova, upskilling, nvidia"; } }
        function downloadFile(filename, content, type) { const blob = new Blob([content], { type: type }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function generateNewsContent(articles, format) { let content = ''; if (format === 'txt') { articles.forEach((article, index) => { content += `--- Article ${index + 1} ---\nTitle: ${article.title}\nSource: ${article.source}\nDate: ${new Date(article.pubDate).toLocaleDateString()}\nLink: ${article.link}\nDescription: ${sanitizeText(article.description)}\nCategories: ${article.categories.map(c => CATEGORIES[c].name || capitalizeFirstLetter(c)).join(', ')}\n\n`; }); } else if (format === 'html') { content += `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>GenAI Pulse News Export</title><style>body{font-family:sans-serif;line-height:1.6;margin:20px;color:#333}.article{border-bottom:1px solid #eee;padding-bottom:20px;margin-bottom:20px}.article:last-child{border-bottom:none;margin-bottom:0}h1{color:#0056b3}h2{color:#0056b3;margin-top:25px}p{margin:5px 0}a{color:#007bff;text-decoration:none}a:hover{text-decoration:underline}.meta{font-size:.9em;color:#666}.meta strong{color:#000}.categories{font-style:italic;color:#888}</style></head><body><h1>GenAI Pulse News Export</h1><p>Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>`; articles.forEach(article => { content += `<div class="article"><h2><a href="${article.link}">${article.title}</a></h2><p class="meta"><strong>Source:</strong> ${article.source} | <strong>Date:</strong> ${new Date(article.pubDate).toLocaleDateString()}</p><p>${sanitizeText(article.description)}</p><p class="categories">Categories: ${article.categories.map(c => CATEGORIES[c].name || capitalizeFirstLetter(c)).join(', ')}</p></div>`; }); content += `</body></html>`; } return content; }
        function formatDateForInput(date) { return date.toISOString().split('T')[0]; }
        function setDefaultDates() { const today = new Date(); const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7); endDateInput.value = formatDateForInput(today); startDateInput.value = formatDateForInput(oneWeekAgo); }
        refreshNewsBtn.addEventListener('click', fetchNews);
        downloadBtn.addEventListener('click', function(event) { event.stopPropagation(); downloadDropdownContent.classList.toggle('show'); });
        window.addEventListener('click', function(event) { if (downloadDropdownContent.classList.contains('show')) { if (!downloadBtn.contains(event.target)) { downloadDropdownContent.classList.remove('show'); } } });
        downloadAllTxtBtn.addEventListener('click', (e) => { e.preventDefault(); const content = generateNewsContent(allNewsArticles, 'txt'); downloadFile('genai_pulse_all_news.txt', content, 'text/plain'); });
        downloadAllHtmlBtn.addEventListener('click', (e) => { e.preventDefault(); const content = generateNewsContent(allNewsArticles, 'html'); downloadFile('genai_pulse_all_news.html', content, 'text/html'); });
        /* MODIFIED: Download filtered now correctly rebuilds the filtered list from scratch */
        function getCurrentlyFilteredArticles() {
            const startDate = new Date(startDateInput.value); const endDate = new Date(endDateInput.value); endDate.setHours(23, 59, 59, 999); const selectedSource = sourceFilter.value;
            let filtered = allNewsArticles.filter(article => { const articleDate = new Date(article.pubDate); return articleDate >= startDate && articleDate <= endDate; });
            if (selectedSource !== 'all') { filtered = filtered.filter(article => article.source === selectedSource); }
            if (!activeCategories.has('all') && activeCategories.size > 0) { filtered = filtered.filter(article => Array.from(activeCategories).some(activeCat => article.categories.includes(activeCat))); }
            if (activeKeywords.size > 0) { filtered = filtered.filter(article => { const content = (article.title + ' ' + article.description).toLowerCase(); return Array.from(activeKeywords).every(keyword => content.includes(keyword)); }); }
            return filtered;
        }
        downloadFilteredTxtBtn.addEventListener('click', (e) => { e.preventDefault(); const content = generateNewsContent(getCurrentlyFilteredArticles(), 'txt'); downloadFile('genai_pulse_filtered_news.txt', content, 'text/plain'); });
        downloadFilteredHtmlBtn.addEventListener('click', (e) => { e.preventDefault(); const content = generateNewsContent(getCurrentlyFilteredArticles(), 'html'); downloadFile('genai_pulse_filtered_news.html', content, 'text/html'); });
        
        startDateInput.addEventListener('change', filterNews);
        endDateInput.addEventListener('change', filterNews);
        /* NEW: Event listener for the source filter */
        sourceFilter.addEventListener('change', filterNews);
        addKeywordBtn.addEventListener('click', addKeyword);
        keywordInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); addKeyword(); } });
        
        document.addEventListener('DOMContentLoaded', () => { 
            setDefaultDates(); 
            createCategoryToggles(); 
            renderKeywordTags(); 
            if (!loadNewsFromLocalStorage()) { 
                fetchNews(); 
            } else { 
                filterNews(); 
            } 
        });
    </script>
</body>
</html>
